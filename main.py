import os
from flask import Flask, request, render_template, send_from_directory, redirect, url_for
from Sandbox import analyze_file, get_report_name

app = Flask(__name__)

# Folder where uploaded files will be stored
UPLOAD_FOLDER = 'uploads'
REPORTS_FOLDER = 'reports'
app.config['UPLOAD_FOLDER'] = UPLOAD_FOLDER
app.config['REPORTS_FOLDER'] = REPORTS_FOLDER
app.config['MAX_CONTENT_LENGTH'] = 16 * 1024 * 1024  # 16 MB max upload size

# Ensure the upload and report directories exist
os.makedirs(UPLOAD_FOLDER, exist_ok=True)
os.makedirs(REPORTS_FOLDER, exist_ok=True)

@app.route("/")
def main():
    return render_template("index.html")

@app.route("/analysis", methods=['GET', 'POST'])
def upload_file():
    if request.method == 'POST':
        file = request.files['file']
        if file:
            filename = file.filename
            filepath = os.path.join(app.config['UPLOAD_FOLDER'], filename)
            file.save(filepath)
            report_file = get_report_name(filepath)
            verdict,report_file = analyze_file(filepath)  # Analyze the file and get the report path
            result_page = 'bad.html' if verdict == "Malware" else 'good.html'
            return redirect(url_for('result', result_page=result_page, report_file=report_file, filename=filename))
    return render_template('index.html')

@app.route('/download/reports/<path:filename>')
def download_file(filename):
    # Replace the original file extension with .pdf
    base_name = os.path.splitext(filename)[0]
    pdf_filename = f"{base_name}.pdf"
    return send_from_directory(directory='reports', path=pdf_filename)

@app.route('/result')
def result():
    result_page = request.args.get('result_page')
    report_file = request.args.get('report_file')
    filename = request.args.get('filename')
    return render_template(result_page, report_file=report_file, filename=filename)

@app.route("/return-home")
def return_home():
    return redirect(url_for('main'))

if __name__ == '__main__':
    app.run(debug=True,port='5064')
